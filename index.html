<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aposta Certa F√°cil - An√°lises Intuitivas</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o do Tailwind para cor principal (azul) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0D47A1', // Azul escuro
                        'accent': '#FFC107', // Amarelo (para destaque)
                        'success': '#4CAF50', // Verde para Odds/Vit√≥ria
                        'danger': '#F44336', // Vermelho para risco
                        'draw': '#FFB300', // Laranja para Empate
                        'win': '#4CAF50', // Verde para Vitoria
                        'loss': '#F44336', // Vermelho para Derrota
                        'low_risk': '#4CAF50', // Baixo (Verde)
                        'mod_risk': '#FFC107', // Moderado (Amarelo)
                        'high_risk': '#F44336', // Alto (Vermelho)
                        'ev_plus': '#10B981', // Verde-esmeralda para EV+
                        'ev_minus': '#EF4444', // Vermelho-forte para EV-
                        // Cores do Guia Avan√ßado
                        'guide-primary': '#667eea', // Roxo claro
                        'guide-secondary': '#764ba2', // Roxo escuro
                        'turf': '#228b22', // Cor base para o fundo 'gramado'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos customizados para apar√™ncia */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out;
        }
        .card-shadow:hover {
            transform: translateY(-4px);
        }
        /* Estilo para os blocos de forma (V, E, D) */
        .form-block {
            width: 16px;
            height: 16px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            border-radius: 4px;
        }
        .drawer-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .drawer-content.open {
            max-height: 500px; /* Valor grande o suficiente para expandir */
        }

        /* --- ESTILOS DO GUIA AVAN√áADO INTEGRADO (Calculadorasix) --- */
        .advanced-guide-section {
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            border-radius: 12px;
            padding: 40px 20px;
            margin-top: 40px;
        }
        .guide-header h2 {
            font-size: 32px;
            font-weight: 800;
            color: #764ba2;
            text-align: center;
            margin-bottom: 30px;
        }
        .content-grid-advanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        .guide-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .guide-card h3 {
            color: #667eea;
            font-size: 20px;
            margin: 0 0 16px 0;
            font-weight: 700;
        }
        .guide-card p, .guide-card li {
            color: #4a5568;
            line-height: 1.6;
            margin: 0 0 12px 0;
        }
        .formula-box {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            text-align: center;
            color: #2d3748;
        }
        .calculator-grid-advanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }
        .calculator-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 24px;
            border: 2px solid #e9ecef;
        }
        .calculator-box h4 {
            color: #764ba2;
            font-size: 20px;
            margin: 0 0 20px 0;
            font-weight: 600;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .calculate-btn-advanced {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
        .result-box-advanced {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 16px;
            margin-top: 16px;
            border-radius: 6px;
            display: none;
        }
        .result-box-advanced.show {
            display: block;
        }
        .result-box-advanced p {
            margin: 0;
            color: #2e7d32;
            font-weight: 600;
            font-size: 16px;
        }
        .highlight {
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        /* FIM ESTILOS GUIA AVAN√áADO */

        /* --- EFEITOS DE FUNDO E CHATBOT --- */

        body {
            /* Fundo limpo e profissional */
            background: #f8f9fa; 
            background-image: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            overflow-x: hidden;
            position: relative;
        }
        
        main, header, footer, section {
            position: relative;
            z-index: 10;
        }
        
        /* Estilos do bot√£o flutuante do Chatbot */
        #chatbot-toggle-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: #0D47A1;
            color: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10000;
            transition: background 0.2s ease;
            font-size: 24px;
            font-weight: bold;
        }
        #chatbot-toggle-button:hover {
            background: #1976D2;
        }

        /* Estilos do Cont√™iner do Chatbot */
        #ai-chatbot-container {
            position: fixed;
            bottom: 96px; /* Acima do bot√£o flutuante */
            right: 24px;
            max-width: 340px;
            z-index: 9999;
            font-family: sans-serif;
            opacity: 0;
            transform: translateY(10px);
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        #ai-chatbot-container.open {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

    </style>
</head>
<body class="bg-gray-50 font-sans">
    
    <!-- Header -->
    <header class="bg-primary shadow-lg p-4 sm:p-6">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-white tracking-tight">
                Aposta Certa F√°cil
            </h1>
            <button onclick="loadAnalysis()" class="bg-accent text-primary font-bold py-2 px-4 rounded-lg hover:bg-yellow-400 transition duration-150">
                Atualizar Dicas Di√°rias
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6">
        <section class="mb-8">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b-2 border-accent pb-2 mb-4">
                Dicas de Valor para Novos Usu√°rios
            </h2>
            <p class="text-gray-600">
                Abaixo, nosso motor simula a an√°lise de estat√≠sticas para simplificar a sua aposta, focando no melhor **"Valor"** do mercado.
            </p>
        </section>

        <!-- GEST√ÉO DE BANCA GLOBAL -->
        <section class="mb-8 bg-white p-6 rounded-xl card-shadow">
            <h3 class="text-lg font-bold text-primary mb-3">üí∞ Gest√£o de Banca (Bankroll)</h3>
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <div class="w-full sm:w-1/2">
                    <label for="bankroll-input" class="text-sm font-medium text-gray-700 block mb-1">Total da Sua Banca (R$):</label>
                    <input type="number" 
                        id="bankroll-input" 
                        oninput="saveBankroll()" 
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                        placeholder="Ex: 1000.00" min="10" step="0.01">
                </div>
                <div class="w-full sm:w-1/2">
                    <p class="text-sm text-gray-600">
                        Informe o valor total que voc√™ reservou para apostas. Usaremos isso para sugerir um **Stake** seguro.
                    </p>
                </div>
            </div>
            <p id="bankroll-status" class="mt-2 text-xs text-gray-500"></p>
        </section>
        
        <!-- NOVO: SE√á√ÉO DE GUIA E CALCULADORAS AVAN√áADAS (AGORA NO TOPO) -->
        <section class="advanced-guide-section mt-12 p-6 sm:p-8 rounded-xl card-shadow">
            <div class="guide-header">
                <h2 id="calculator-title">üß† Guia de Estrat√©gias e Calculadoras Avan√ßadas</h2>
                <p class="text-gray-700 text-center mb-8">Utilize as ferramentas abaixo para aprofundar suas an√°lises e gest√£o de risco.</p>
            </div>
            
            <div class="content-grid-advanced">
                <div class="guide-card">
                    <h3>üéØ Gest√£o de Banca e Unidades</h3>
                    <p>A base de qualquer estrat√©gia profissional. Sem gest√£o adequada, at√© as melhores an√°lises falham.</p>
                    <div class="formula-box">
                        Valor da Unidade = Banca Total / N√∫mero de Unidades
                    </div>
                    <div class="input-group"><label for="bankroll-units">Banca Total (R$):</label> <input type="number" id="bankroll-units" step="1" min="1" placeholder="Ex: 1000">
                    </div>
                    <div class="input-group"><label for="num-units">N√∫mero de Unidades:</label> <input type="number" id="num-units" step="1" min="1" value="100" placeholder="Ex: 100">
                    </div><button class="calculate-btn-advanced" onclick="calculateUnits()">Calcular Unidades</button>
                    <div class="result-box-advanced" id="result-units">
                        <p id="result-units-text"></p>
                    </div>
                </div>

                <div class="guide-card">
                    <h3>üíé Valor Esperado (EV+) e Probabilidade</h3>
                    <p>O conceito mais importante: encontrar apostas onde a probabilidade real √© maior que a impl√≠cita nas odds.</p>
                    <div class="formula-box">
                        Prob. Impl√≠cita = 1 / Odd
                    </div>
                    <div class="input-group"><label for="odd-prob">Odd Oferecida:</label> <input type="number" id="odd-prob" step="0.01" min="1.01" placeholder="Ex: 2.50">
                    </div><button class="calculate-btn-advanced" onclick="calculateImpliedProb()">Probabilidade Impl√≠cita</button>
                    <div class="result-box-advanced" id="result-prob">
                        <p id="result-prob-text"></p>
                    </div>
                    <div class="input-group mt-4"><label for="prob-real">Probabilidade Real (%):</label> <input type="number" id="prob-real" step="0.1" min="0" max="100" placeholder="Ex: 55">
                    </div>
                    <div class="input-group"><label for="odd-ev">Odd Oferecida:</label> <input type="number" id="odd-ev" step="0.01" min="1.01" placeholder="Ex: 2.00">
                    </div><button class="calculate-btn-advanced" onclick="calculateEV()">Calcular EV</button>
                    <div class="result-box-advanced" id="result-ev">
                        <p id="result-ev-text"></p>
                    </div>
                </div>
                
                <div class="guide-card">
                    <h3>üìä Crit√©rio de Kelly</h3>
                    <p>F√≥rmula matem√°tica que calcula o tamanho ideal da aposta baseado no valor identificado.</p>
                    <div class="formula-box">
                        Kelly% = $\small \frac{(\text{Prob} \times \text{Odd}) - 1}{\text{Odd} - 1}$
                    </div>
                    <div class="input-group"><label for="prob-kelly">Probabilidade Real (%):</label> <input type="number" id="prob-kelly" step="0.1" min="0" max="100" placeholder="Ex: 55">
                    </div>
                    <div class="input-group"><label for="odd-kelly">Odd Oferecida:</label> <input type="number" id="odd-kelly" step="0.01" min="1.01" placeholder="Ex: 2.00">
                    </div>
                    <div class="input-group"><label for="bankroll">Banca Total (R$):</label> <input type="number" id="bankroll-kelly" step="1" min="1" placeholder="Ex: 1000">
                    </div><button class="calculate-btn-advanced" onclick="calculateKelly()">Calcular Kelly</button>
                    <div class="result-box-advanced" id="result-kelly">
                        <p id="result-kelly-text"></p>
                    </div>
                </div>
            </div>

            <div class="mt-12">
                <h3 class="guide-header h2 text-guide-secondary mb-6">üßÆ Calculadoras de Mercado e Modelagem</h3>
                <div class="calculator-grid-advanced">
                    
                    <div class="calculator-box">
                        <h4>Handicap Asi√°tico</h4>
                        <p class="text-sm text-gray-500 mb-3">Simule o resultado de diferentes linhas de Handicap.</p>
                        <div class="input-group"><label for="handicap-line">Linha do Handicap:</label> 
                            <select id="handicap-line" class="p-2 border border-gray-300 rounded-lg"> 
                                <option value="-0.5">-0.5 (Vit√≥ria simples)</option> 
                                <option value="0">0.0 (Draw No Bet)</option> 
                                <option value="-0.25">-0.25 (Quarto de linha)</option> 
                                <option value="-1.5">-1.5 (Vencer por 2+)</option> 
                                <option value="+0.5">+0.5 (N√£o perder)</option> 
                                <option value="+1.5">+1.5 (Perder por 1 ou n√£o perder)</option> 
                            </select>
                        </div>
                        <div class="input-group"><label for="final-score">Placar Final (Casa x Visitante):</label> <input type="text" id="final-score" placeholder="Ex: 2x1 ou 1x1" pattern="[0-9]+x[0-9]+">
                        </div>
                        <div class="input-group"><label for="bet-amount">Valor Apostado (R$):</label> <input type="number" id="bet-amount" step="0.01" min="0" placeholder="Ex: 100">
                        </div>
                        <div class="input-group"><label for="handicap-odd">Odd do Handicap:</label> <input type="number" id="handicap-odd" step="0.01" min="1.01" placeholder="Ex: 1.85">
                        </div><button class="calculate-btn-advanced" onclick="calculateHandicap()">Calcular Resultado</button>
                        <div class="result-box-advanced" id="result-handicap">
                            <p id="result-handicap-text"></p>
                        </div>
                    </div>
                    
                    <div class="calculator-box">
                        <h4>Simulador de Poisson</h4>
                        <p class="text-sm text-gray-500 mb-3">Estime a probabilidade de placares com base nas m√©dias de gols.</p>
                        <div class="input-group"><label for="team-a-goals">M√©dia de Gols Time A (Casa):</label> <input type="number" id="team-a-goals" step="0.1" min="0" placeholder="Ex: 1.5">
                        </div>
                        <div class="input-group"><label for="team-b-goals">M√©dia de Gols Time B (Visitante):</label> <input type="number" id="team-b-goals" step="0.1" min="0" placeholder="Ex: 1.2">
                        </div><button class="calculate-btn-advanced" onclick="calculatePoisson()">Simular Probabilidades</button>
                        <div class="result-box-advanced" id="result-poisson">
                            <p id="result-poisson-text"></p>
                        </div>
                    </div>
                    
                    <div class="calculator-box">
                        <h4>Guia R√°pido: Vantagens de Mercado</h4>
                        <p class="text-sm text-gray-500 mb-3">Entenda as vantagens do Handicap Asi√°tico (HA).</p>
                        <ul class="list-disc pl-5 space-y-2 text-gray-700 text-sm">
                            <li>**HA 0.0:** Empate = Devolu√ß√£o da Aposta.</li>
                            <li>**HA -0.25:** Vit√≥ria = Ganho Total. Empate = Perde Metade.</li>
                            <li>**HA +0.5:** Aposta ganha se o time n√£o perder.</li>
                            <li>**Over/Under:** A linha quebrada (2.5, 1.5) elimina a devolu√ß√£o.</li>
                        </ul>
                        <p class="mt-4 text-xs text-guide-secondary">
                            A an√°lise avan√ßada permite encontrar valor em odds que o mercado tradicional ignora.
                        </p>
                    </div>

                </div>
            </div>
        </section>
        <!-- FIM GUIA AVAN√áADO -->


        <!-- Indicador de Carregamento/Status -->
        <div id="loading-status" class="text-center text-gray-500 mb-6 hidden">
            <p>Carregando an√°lises di√°rias...</p>
        </div>

        <!-- Container para os cart√µes de an√°lise -->
        <div id="analysis-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Os cart√µes de jogos ser√£o injetados aqui -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-6 mt-12">
        <div class="max-w-7xl mx-auto text-center text-sm">
            <p>&copy; 2025 Aposta Certa F√°cil - PENSADO COM IA</p>
        </div>
    </footer>

    <!-- NOVO: CHATBOT GEMINI INTEGRADO (Inicia Fechado) -->
    <div id="ai-chatbot-container" class="" style="position:fixed;bottom:96px;right:24px;max-width:340px;z-index:9999;font-family:sans-serif;">
        <div style="background:#0D47A1;color:white;padding:12px;border-radius:10px 10px 0 0; font-weight: bold;">
            üß† Assistente de Estrat√©gias (IA)
        </div>
        <div id="ai-chat-messages" style="background:white;height:320px;overflow-y:auto;padding:10px;border:1px solid #ccc;border-top:0"></div>
        <form id="ai-chat-form" style="display:flex;background:white;border-radius:0 0 10px 10px;">
            <input id="ai-chat-input" placeholder="Pergunte sobre EV, Kelly, ou an√°lise..." autocomplete="off" style="flex:1;border:none;padding:10px;font-size:15px;">
            <button style="background:#0D47A1;color:white;border:none;padding:10px 18px;cursor:pointer;border-radius:0 0 10px 0; font-weight: bold;">Enviar</button>
        </form>
    </div>
    
    <!-- Bot√£o Flutuante de Abertura do Chatbot -->
    <div id="chatbot-toggle-button" onclick="toggleChatbot()">
        üí¨
    </div>
    <!-- FIM NOVO CHATBOT GEMINI INTEGRADO -->

    <script>
        // Constantes para Casas de Apostas
        const BOOKMAKERS = ['Betano', 'Superbet', 'Bet365', 'Pixbet', 'Esportes da Sorte'];

        // Vari√°vel global para armazenar o valor da banca
        let userBankroll = 0;
        
        // --- NOVO: Vari√°vel para o Timer de Atualiza√ß√£o ---
        const AUTO_UPDATE_INTERVAL = 300000; // 5 minutos em milissegundos

        // Mapeamento de Risco para Porcentagem de Stake
        const STAKE_MAP = {
            'Muito Baixo': 0.01, // 1%
            'Baixo': 0.02,       // 2%
            'Moderado': 0.03,    // 3%
            'Alto': 0.05,        // 5%
        };

        // Fun√ß√£o utilit√°ria para obter a cor do bloco de forma
        function getFormColor(result) {
            switch (result) {
                case 'V': return 'bg-win'; // Vit√≥ria (Win)
                case 'E': return 'bg-draw'; // Empate (Draw)
                case 'D': return 'bg-loss'; // Derrota (Loss)
                default: return 'bg-gray-400';
            }
        }
        
        /**
         * Calcula o Stake sugerido baseado no n√≠vel de risco e na banca do usu√°rio.
         * @param {string} riskLevel - N√≠vel de risco da dica ('Baixo', 'Moderado', etc.).
         * @returns {number} Valor do Stake sugerido.
         */
        function getSuggestedStake(riskLevel) {
            if (userBankroll <= 0) return 0;
            const percentage = STAKE_MAP[riskLevel] || 0.01; // Padr√£o 1%
            return (userBankroll * percentage).toFixed(2);
        }

        /**
         * Salva o valor da banca e atualiza todas as sugest√µes de stake.
         */
        function saveBankroll() {
            const input = document.getElementById('bankroll-input');
            const status = document.getElementById('bankroll-status');
            const value = parseFloat(input.value);
            
            if (isNaN(value) || value <= 0) {
                userBankroll = 0;
                status.textContent = 'Informe sua banca para receber sugest√µes de aposta seguras.';
            } else {
                userBankroll = value;
                status.textContent = `Banca registrada: R$ ${userBankroll.toFixed(2)}. As sugest√µes de aposta (Stake) ser√£o calculadas automaticamente.`;
            }

            // Recarrega as an√°lises para atualizar o stake sugerido em todos os cart√µes
            loadAnalysis(false); 
        }

        /**
         * Simula a busca de dados de jogos de uma API externa.
         * ESTA FUN√á√ÉO FOI ATUALIZADA COM OS JOGOS DE HOJE (06/11/2025)
         */
        async function fetchDailyGames() {
            // Simula√ß√£o de delay de rede
            await new Promise(resolve => setTimeout(resolve, 800)); 

            // Dados ATUALIZADOS com base na pesquisa Google de 06/11/2025 (Brasileir√£o e Europa)
            return [
                {
                    id: 1,
                    teamA: 'Palmeiras',
                    teamB: 'Santos',
                    time: '21:30',
                    venue: 'Allianz Parque',
                    // Odds m√©dias: 1.48 | 4.33 | 7.50
                    odds1X2: { '1': 1.48, 'X': 4.33, '2': 7.50 },
                    formA: 'V-V-E-D-V', // Bom momento
                    formB: 'E-E-D-V-D', // Luta contra Z4
                    scaleA: 9, 
                    scaleB: 5,
                    estimatedProb: 0.68, // 68% de chance de vit√≥ria (EV+ na Odd 1.48)
                    recommendedTip: {
                        market: 'RESULTADO',
                        description: 'Aposte na **Vit√≥ria Simples do Palmeiras (1)**',
                        odds: 1.48,
                        rationale: 'O Palmeiras √© l√≠der e est√° em excelente forma em casa (Scale 9). O Santos luta contra o Z4 (Scale 5). Aposta de **Baixo Risco** no favorito.',
                        riskLevel: 'Baixo' // 2% Stake
                    },
                    secondaryTip: {
                        market: 'GOLS',
                        description: 'Aposte em **Menos de 3.5 Gols** (Under 3.5)',
                        odds: 1.25, // Odd baixa, mas segura para o cen√°rio de cl√°ssico
                        riskLevel: 'Muito Baixo'
                    }
                },
                {
                    id: 2,
                    teamA: 'Cear√°',
                    teamB: 'Fortaleza',
                    time: '20:00',
                    venue: 'Castel√£o',
                    // Odds m√©dias: 2.40 | 3.25 | 3.00
                    odds1X2: { '1': 2.40, 'X': 3.25, '2': 3.00 },
                    formA: 'D-D-D-E-V', // Inconsistente
                    formB: 'E-V-D-D-V', // Inconsistente
                    scaleA: 6,
                    scaleB: 6,
                    estimatedProb: 0.65, // 65% de chance de Under 2.5 (EV+ na Odd 1.50)
                    recommendedTip: {
                        market: 'GOLS',
                        description: 'Aposte em **Menos de 2.5 Gols** (Under 2.5)',
                        odds: 1.50,
                        rationale: 'Cl√°ssico regional conhecido pela marca√ß√£o forte e poucos gols. A aposta mais segura √© no limite de gols. Aposta de **Muito Baixo Risco**.',
                        riskLevel: 'Muito Baixo' // 1% Stake
                    },
                    secondaryTip: {
                        market: 'PLENO (X)',
                        description: 'Aposte no **Empate** (X)',
                        odds: 3.25,
                        riskLevel: 'Moderado'
                    }
                },
                {
                    id: 3,
                    teamA: 'Fluminense',
                    teamB: 'Mirassol',
                    time: '19:30',
                    venue: 'Maracan√£',
                    // Odds m√©dias: 1.85 | 3.35 | 4.90
                    odds1X2: { '1': 1.85, 'X': 3.35, '2': 4.90 },
                    formA: 'V-V-V-D-E', // Boa forma em casa
                    formB: 'V-D-V-E-E', // Momento de recupera√ß√£o
                    scaleA: 7,
                    scaleB: 5,
                     // Valor estimado pela IA para o evento (ex: 58% de chance de vit√≥ria do Flu)
                    estimatedProb: 0.58, 
                    recommendedTip: {
                        market: 'HANDICAP',
                        description: 'Aposte no **Fluminense (Handicap Asi√°tico 0.0)**',
                        odds: 1.35, // Cota√ß√£o ajustada para Handicap 0.0
                        rationale: 'O Fluminense √© favorito e joga em casa para garantir vaga na Libertadores. O HA 0.0 protege contra o empate. Aposta de **Baixo Risco**.',
                        riskLevel: 'Baixo' // 2% Stake
                    },
                    secondaryTip: {
                        market: 'GOLS',
                        description: 'Aposte em **Menos de 2.5 Gols** (Under 2.5)',
                        odds: 1.67,
                        riskLevel: 'Baixo'
                    }
                }
            ];
        }

        /**
         * Calcula o Valor Esperado (Expected Value - EV) da aposta.
         * EV = (Probabilidade Real * Odd) - 1
         * @param {number} odd - Odd oferecida.
         * @param {number} prob - Probabilidade real estimada (em decimal, ex: 0.60).
         * @returns {number} O Valor Esperado.
         */
        function calculateEV(odd, prob) {
            if (odd <= 1.0 || prob <= 0) return 0;
            return (prob * odd) - 1;
        }

        /**
         * Alterna a visibilidade do painel de an√°lise avan√ßada (drawer).
         * @param {number} gameId - ID do jogo.
         */
        function toggleAdvancedAnalysis(gameId) {
            const drawer = document.getElementById(`advanced-analysis-${gameId}`);
            const icon = document.getElementById(`toggle-icon-${gameId}`);

            if (drawer.classList.contains('open')) {
                drawer.classList.remove('open');
                icon.textContent = 'Mais Detalhes +';
            } else {
                drawer.classList.add('open');
                icon.textContent = 'Menos Detalhes -';
            }
        }

        /**
         * Gera o HTML para o cart√£o de an√°lise de um jogo.
         */
        function renderGameCard(game) {
            const { id, teamA, teamB, time, venue, odds1X2, recommendedTip, secondaryTip, formA, formB, scaleA, scaleB, estimatedProb } = game;
            
            // Determina a cor do risco
            const riskColor = recommendedTip.riskLevel === 'Baixo' ? 'bg-success' : 
                              recommendedTip.riskLevel === 'Moderado' ? 'bg-accent text-gray-800' : 
                              recommendedTip.riskLevel === 'Muito Baixo' ? 'bg-indigo-500' : 'bg-danger';
            
            // Calcula o stake sugerido para preencher o campo
            const suggestedStake = getSuggestedStake(recommendedTip.riskLevel);

            // Calcula o EV e determina a cor do EV
            const evValue = calculateEV(recommendedTip.odds, estimatedProb);
            const evColor = evValue > 0 ? 'text-ev_plus' : 'text-ev_minus';
            const evSign = evValue > 0 ? '+' : '';

            // Probabilidade impl√≠cita da casa
            const impliedProb = (1 / recommendedTip.odds) * 100;

            // Cria os blocos de forma (V-E-D) para o Time A
            const formBlocksA = formA.split('-').map(result => `
                <span class="form-block ${getFormColor(result)}">${result}</span>
            `).join('');

            // Cria os blocos de forma (V-E-D) para o Time B
            const formBlocksB = formB.split('-').map(result => `
                <span class="form-block ${getFormColor(result)}">${result}</span>
            `).join('');

            // NOVO TEXTO PARA O BOT√ÉO
            const newButtonText = `CONSULTAR DICA (Copiar)`;

            return `
                <div class="bg-white rounded-xl overflow-hidden card-shadow">
                    <div class="p-4 sm:p-6">
                        <!-- T√≠tulo e Detalhes do Jogo -->
                        <div class="mb-4 border-b pb-2">
                            <h4 class="text-xl font-bold text-primary">${teamA} vs ${teamB}</h4>
                            <div class="flex justify-between text-sm text-gray-500 mt-1">
                                <span>${venue}</span>
                                <span>${time} (Hor√°rio de Bras√≠lia)</span>
                            </div>
                        </div>
                        
                        <!-- Escala de For√ßa e Forma Recente -->
                        <div class="mb-4 space-y-3">
                            <!-- Time A -->
                            <div class="flex justify-between items-center text-sm">
                                <span class="font-semibold text-gray-700">${teamA} (Scale: ${scaleA}/10)</span>
                                <div class="flex space-x-1">${formBlocksA}</div>
                            </div>
                            <!-- Time B -->
                            <div class="flex justify-between items-center text-sm">
                                <span class="font-semibold text-gray-700">${teamB} (Scale: ${scaleB}/10)</span>
                                <div class="flex space-x-1">${formBlocksB}</div>
                            </div>
                        </div>

                        <!-- Odds Principais (1X2) -->
                        <div class="flex justify-around text-center mb-4 border-t pt-3">
                            <div><span class="text-gray-500 text-sm">Vit√≥ria ${teamA} (1)</span><p class="font-bold text-lg text-success">${odds1X2['1'].toFixed(2)}</p></div>
                            <div><span class="text-gray-500 text-sm">Empate (X)</span><p class="font-bold text-lg text-gray-700">${odds1X2['X'].toFixed(2)}</p></div>
                            <div><span class="text-gray-500 text-sm">Vit√≥ria ${teamB} (2)</span><p class="font-bold text-lg text-gray-700">${odds1X2['2'].toFixed(2)}</p></div>
                        </div>

                        <!-- DICA RECOMENDADA (A Aposta Certa F√°cil) -->
                        <div class="bg-primary bg-opacity-10 border border-primary p-4 rounded-lg mb-4">
                            <h5 class="text-lg font-bold text-primary mb-2 flex items-center">
                                <span class="mr-2 text-2xl">üí°</span> DICA F√ÅCIL DO DIA (${recommendedTip.market})
                            </h5>
                            <p id="tip-text-${game.id}" class="text-gray-700 mb-2 font-semibold text-base">${recommendedTip.description.replace(/\*\*/g, ' ')}</p>
                            
                            <div class="flex justify-between items-center mt-3">
                                <span class="text-2xl font-extrabold text-success">
                                    Odd: ${recommendedTip.odds.toFixed(2)}
                                </span>
                                <span class="text-sm font-semibold py-1 px-3 rounded-full text-white ${riskColor}">
                                    Risco: ${recommendedTip.riskLevel}
                                </span>
                            </div>

                            <!-- CALCULADORA DE GANHOS -->
                            <div class="mt-4 pt-3 border-t border-primary/20">
                                <label for="stake-input-${game.id}" class="text-sm font-medium text-primary block mb-1">Seu Valor de Aposta (R$):</label>
                                <input type="number" 
                                    id="stake-input-${game.id}" 
                                    oninput="calculateGain(${game.id}, ${recommendedTip.odds})" 
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent"
                                    placeholder="Ex: 50.00" min="0.01" step="0.01"
                                    value="${suggestedStake > 0 ? suggestedStake : ''}"
                                    >
                                ${suggestedStake > 0 ? `<p class="text-xs text-primary/70 mt-1">Stake Sugerido (${STAKE_MAP[recommendedTip.riskLevel] * 100}% da Banca): R$ ${suggestedStake}</p>` : ''}
                            </div>

                            <div id="result-display-${game.id}" class="mt-2 p-3 bg-primary text-white rounded-lg text-sm hidden">
                                <!-- Resultado ser√° injetado aqui -->
                            </div>
                        </div>

                        <!-- Racional da Aposta -->
                        <p class="text-sm text-gray-500 mb-4">
                            **Racional:** ${recommendedTip.rationale}
                        </p>

                        <!-- Bot√£o de A√ß√£o -->
                        <button onclick="copyTip(${game.id})" class="block w-full text-center bg-accent text-gray-900 font-bold py-3 rounded-xl text-lg hover:bg-yellow-500 transition duration-150 transform hover:scale-[1.02]">
                            ${newButtonText}
                        </button>
                        <p id="copy-status-${game.id}" class="text-center text-xs text-success mt-2 hidden">Dica copiada! ‚úÖ</p>

                        <!-- Sugest√£o de Casas de Apostas -->
                        <div class="mt-4 text-center text-sm text-gray-500">
                            <p class="font-semibold mb-1">Dispon√≠vel em casas como:</p>
                            <span class="text-xs text-gray-600">${BOOKMAKERS.join(' | ')}</span>
                        </div>


                        <!-- Dica Secund√°ria -->
                        <div class="text-center mt-3 pt-3 border-t border-gray-100">
                             <p class="text-xs text-gray-500">Alternativa: ${secondaryTip.description.replace(/\*\*/g, ' ')} (Odd ${secondaryTip.odds.toFixed(2)})</p>
                        </div>

                        <!-- PAINEL DE AN√ÅLISE AVAN√áADA (DRAWER) -->
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <button onclick="toggleAdvancedAnalysis(${game.id})" class="text-primary text-sm font-semibold hover:text-blue-700 transition duration-150">
                                <span id="toggle-icon-${game.id}">Mais Detalhes +</span>
                            </button>
                            <div id="advanced-analysis-${game.id}" class="drawer-content pt-3">
                                <h6 class="text-md font-bold text-gray-700 mb-2">üìä Valor Esperado (EV)</h6>
                                <div class="bg-gray-100 p-3 rounded-lg text-sm">
                                    <p class="mb-1">Prob. Estimada pela IA: <span class="font-bold">${(estimatedProb * 100).toFixed(1)}%</span></p>
                                    <p class="mb-1">Prob. Impl√≠cita da Casa: <span class="font-bold">${impliedProb.toFixed(1)}%</span></p>
                                    <p class="text-lg font-extrabold mt-2 ${evColor}">
                                        Valor Esperado (EV): ${evSign}${(evValue * 100).toFixed(2)}%
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        EV > 0% indica que a aposta tem Valor no longo prazo.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // NOVO: Fun√ß√£o para copiar a dica
        function copyTip(gameId) {
            const tipTextElement = document.getElementById(`tip-text-${gameId}`);
            const copyStatusElement = document.getElementById(`copy-status-${gameId}`);
            
            // Texto completo a ser copiado
            const fullTipText = `DICA F√ÅCIL: ${tipTextElement.textContent.trim()} | Odd: ${document.getElementById(`stake-input-${gameId}`).value ? document.getElementById(`stake-input-${game.id}`).value : 'N/A'}`;
            
            // Usando execCommand('copy') como fallback para iFrames
            const tempInput = document.createElement('textarea');
            tempInput.value = fullTipText;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                copyStatusElement.classList.remove('hidden');
                setTimeout(() => {
                    copyStatusElement.classList.add('hidden');
                }, 2000);
            } catch (err) {
                console.error('Falha ao copiar:', err);
                copyStatusElement.textContent = 'Erro ao copiar. Tente selecionar o texto.';
                copyStatusElement.classList.remove('hidden');
                setTimeout(() => {
                    copyStatusElement.classList.add('hidden');
                }, 2000);
            } finally {
                document.body.removeChild(tempInput);
            }
        }
        
        /**
         * Calcula o retorno e lucro de uma aposta e atualiza o display.
         * @param {number} gameId - ID √∫nico do jogo.
         * @param {number} odd - Odd da aposta recomendada.
         */
        function calculateGain(gameId, odd) {
            const input = document.getElementById(`stake-input-${gameId}`);
            const display = document.getElementById(`result-display-${gameId}`);
            // Usa toFixed(2) na string para garantir 2 casas decimais no c√°lculo
            const stake = parseFloat(parseFloat(input.value).toFixed(2));

            if (isNaN(stake) || stake <= 0) {
                display.classList.add('hidden');
                return;
            }

            const totalReturn = stake * odd;
            const netProfit = totalReturn - stake;

            display.innerHTML = `
                <p>Retorno Total: <span class="font-bold">R$ ${totalReturn.toFixed(2)}</span></p>
                <p>Lucro L√≠quido: <span class="font-bold">R$ ${netProfit.toFixed(2)}</span></p>
            `;
            display.classList.remove('hidden');
        }


        /**
         * Carrega e renderiza os dados de an√°lise, incluindo o status de carregamento.
         * @param {boolean} showLoading - Define se deve mostrar o status de carregamento.
         */
        async function loadAnalysis(showLoading = true) {
            const container = document.getElementById('analysis-container');
            const status = document.getElementById('loading-status');
            
            container.innerHTML = ''; 
            if (showLoading) status.classList.remove('hidden'); // Mostra o status de carregamento

            // 1. Simula a busca di√°ria de dados
            let analysisData;
            try {
                analysisData = await fetchDailyGames();
            } catch (error) {
                console.error("Erro ao carregar dados di√°rios:", error);
                status.innerHTML = '<p class="text-danger">Erro ao carregar os jogos. Tente novamente mais tarde.</p>';
                return;
            } finally {
                if (showLoading) status.classList.add('hidden'); // Esconde o status
            }

            // 2. Renderiza os cart√µes de an√°lise
            if (analysisData.length === 0) {
                container.innerHTML = '<p class="text-center text-lg text-gray-600">Nenhum jogo de valor encontrado para hoje. Volte amanh√£!</p>';
            } else {
                analysisData.forEach(game => {
                    container.innerHTML += renderGameCard(game);
                });
                console.log(`An√°lises de ${analysisData.length} jogos carregadas com sucesso.`);
            }
        }

        // --- FUN√á√ïES CALCULADORAS AVAN√áADAS (Integradas do seu modelo) ---

        function calculateImpliedProb() {
            const odd = parseFloat(document.getElementById('odd-prob').value);
            const resultBox = document.getElementById('result-prob');
            const resultText = document.getElementById('result-prob-text');
            resultBox.classList.remove('show');

            if (!odd || odd < 1.01) {
                resultText.textContent = 'Por favor, insira uma odd v√°lida (maior que 1.00)';
                resultBox.classList.add('show');
                return;
            }

            const impliedProb = (1 / odd) * 100;
            resultText.textContent = `Probabilidade Impl√≠cita: ${impliedProb.toFixed(2)}%`;
            resultBox.classList.add('show');
        }

        function calculateEV() {
            const probReal = parseFloat(document.getElementById('prob-real').value) / 100;
            const odd = parseFloat(document.getElementById('odd-ev').value);
            const resultBox = document.getElementById('result-ev');
            const resultText = document.getElementById('result-ev-text');
            resultBox.classList.remove('show');

            if (!probReal || !odd || probReal < 0 || probReal > 1 || odd < 1.01) {
                resultText.textContent = 'Por favor, insira valores v√°lidos';
                resultBox.classList.add('show');
                return;
            }

            const ev = (probReal * odd) - 1;
            const evPercent = ev * 100;

            if (ev > 0) {
                resultText.innerHTML = `EV = +${evPercent.toFixed(2)}% ‚úÖ (Aposta com <span class="font-extrabold text-ev_plus">VALOR</span>!)`;
                resultBox.style.borderLeftColor = '#10B981';
            } else {
                resultText.innerHTML = `EV = ${evPercent.toFixed(2)}% ‚ùå (<span class="font-extrabold text-ev_minus">Sem valor</span>)`;
                resultBox.style.borderLeftColor = '#EF4444';
            }
            resultBox.classList.add('show');
        }

        function calculateKelly() {
            const probReal = parseFloat(document.getElementById('prob-kelly').value) / 100;
            const odd = parseFloat(document.getElementById('odd-kelly').value);
            const bankroll = parseFloat(document.getElementById('bankroll-kelly').value);
            const resultBox = document.getElementById('result-kelly');
            const resultText = document.getElementById('result-kelly-text');
            resultBox.classList.remove('show');

            if (!probReal || !odd || !bankroll || probReal < 0 || probReal > 1 || odd < 1.01 || bankroll <= 0) {
                resultText.textContent = 'Por favor, insira valores v√°lidos';
                resultBox.classList.add('show');
                return;
            }

            const kelly = ((probReal * odd) - 1) / (odd - 1);
            const kellyPercent = kelly * 100;
            const kellyAmount = bankroll * kelly;
            const halfKelly = kellyAmount / 2;
            const quarterKelly = kellyAmount / 4;

            if (kelly <= 0) {
                resultText.textContent = 'Kelly = 0% - N√£o aposte (sem valor)';
                resultBox.style.borderLeftColor = '#EF4444';
            } else {
                resultText.innerHTML = `
                    <p><strong>Kelly Completo:</strong> ${kellyPercent.toFixed(2)}% (R$ ${kellyAmount.toFixed(2)})</p>
                    <p><strong>Meio-Kelly (recomendado):</strong> ${(kellyPercent/2).toFixed(2)}% (R$ ${halfKelly.toFixed(2)})</p>
                    <p><strong>Quarter-Kelly (conservador):</strong> ${(kellyPercent/4).toFixed(2)}% (R$ ${quarterKelly.toFixed(2)})</p>
                `;
                resultBox.style.borderLeftColor = '#4caf50';
            }
            resultBox.classList.add('show');
        }

        function calculateUnits() {
            const bankroll = parseFloat(document.getElementById('bankroll-units').value);
            const numUnits = parseFloat(document.getElementById('num-units').value);
            const resultBox = document.getElementById('result-units');
            const resultText = document.getElementById('result-units-text');
            resultBox.classList.remove('show');

            if (!bankroll || !numUnits || bankroll <= 0 || numUnits <= 0) {
                resultText.textContent = 'Por favor, insira valores v√°lidos';
                resultBox.classList.add('show');
                return;
            }

            const unitValue = bankroll / numUnits;
            const oneUnitPercent = (1 / numUnits) * 100;
            const twoUnits = unitValue * 2;
            const threeUnits = unitValue * 3;

            resultText.innerHTML = `
                <p><strong>Valor de 1 unidade:</strong> R$ ${unitValue.toFixed(2)} (${oneUnitPercent.toFixed(2)}%)</p>
                <p><strong>2 unidades:</strong> R$ ${twoUnits.toFixed(2)}</p>
                <p><strong>3 unidades:</strong> R$ ${threeUnits.toFixed(2)}</p>
            `;
            resultBox.classList.add('show');
        }

        function calculateHandicap() {
            const handicapLine = parseFloat(document.getElementById('handicap-line').value);
            const finalScore = document.getElementById('final-score').value;
            const betAmount = parseFloat(document.getElementById('bet-amount').value);
            const odd = parseFloat(document.getElementById('handicap-odd').value);
            const resultBox = document.getElementById('result-handicap');
            const resultText = document.getElementById('result-handicap-text');
            resultBox.classList.remove('show');

            if (!finalScore || !betAmount || !odd || betAmount <= 0 || odd < 1.01) {
                resultText.textContent = 'Por favor, insira valores v√°lidos';
                resultBox.classList.add('show');
                return;
            }

            const scoreMatch = finalScore.match(/(\d+)x(\d+)/);
            if (!scoreMatch) {
                resultText.textContent = 'Formato de placar inv√°lido. Use: 2x1';
                resultBox.classList.add('show');
                return;
            }

            const homeGoals = parseInt(scoreMatch[1]);
            const awayGoals = parseInt(scoreMatch[2]);
            const goalDifference = homeGoals - awayGoals;

            let result = '';
            let profit = 0;
            let totalReturn = 0;

            if (handicapLine === -0.5) {
                if (goalDifference > 0) {
                    totalReturn = betAmount * odd;
                    profit = totalReturn - betAmount;
                    result = `‚úÖ GANHOU! Retorno Total: R$ ${totalReturn.toFixed(2)} (Lucro: R$ ${profit.toFixed(2)})`;
                } else {
                    profit = -betAmount;
                    result = `‚ùå PERDEU! Preju√≠zo: R$ ${Math.abs(profit).toFixed(2)}`;
                }
            } else if (handicapLine === 0) {
                if (goalDifference > 0) {
                    totalReturn = betAmount * odd;
                    profit = totalReturn - betAmount;
                    result = `‚úÖ GANHOU! Retorno Total: R$ ${totalReturn.toFixed(2)} (Lucro: R$ ${profit.toFixed(2)})`;
                } else if (goalDifference === 0) {
                    profit = 0;
                    result = `üîÑ EMPATE! Aposta devolvida (R$ ${betAmount.toFixed(2)})`;
                } else {
                    profit = -betAmount;
                    result = `‚ùå PERDEU! Preju√≠zo: R$ ${Math.abs(profit).toFixed(2)}`;
                }
            } else if (handicapLine === -0.25) {
                if (goalDifference > 0) {
                    totalReturn = betAmount * odd;
                    profit = totalReturn - betAmount;
                    result = `‚úÖ GANHOU! Retorno Total: R$ ${totalReturn.toFixed(2)} (Lucro: R$ ${profit.toFixed(2)})`;
                } else if (goalDifference === 0) {
                    profit = -betAmount / 2;
                    result = `‚ö†Ô∏è MEIO PERDEU! Preju√≠zo: R$ ${Math.abs(profit).toFixed(2)} (R$ ${betAmount / 2} devolvidos)`;
                } else {
                    profit = -betAmount;
                    result = `‚ùå PERDEU! Preju√≠zo: R$ ${Math.abs(profit).toFixed(2)}`;
                }
            } else if (handicapLine === -1.5) {
                if (goalDifference >= 2) {
                    totalReturn = betAmount * odd;
                    profit = totalReturn - betAmount;
                    result = `‚úÖ GANHOU! Retorno Total: R$ ${totalReturn.toFixed(2)} (Lucro: R$ ${profit.toFixed(2)})`;
                } else {
                    profit = -betAmount;
                    result = `‚ùå PERDEU! Preju√≠zo: R$ ${Math.abs(profit).toFixed(2)}`;
                }
            } else if (handicapLine === +0.5) {
                if (goalDifference >= 0) { // Vit√≥ria ou Empate
                    totalReturn = betAmount * odd;
                    profit = totalReturn - betAmount;
                    result = `‚úÖ GANHOU! Retorno Total: R$ ${totalReturn.toFixed(2)} (Lucro: R$ ${profit.toFixed(2)})`;
                } else {
                    profit = -betAmount;
                    result = `‚ùå PERDEU! Preju√≠zo: R$ ${Math.abs(profit).toFixed(2)}`;
                }
            } else if (handicapLine === +1.5) {
                if (goalDifference >= -1) { // Vit√≥ria, Empate, ou Derrota por 1 gol
                    totalReturn = betAmount * odd;
                    profit = totalReturn - betAmount;
                    result = `‚úÖ GANHOU! Retorno Total: R$ ${totalReturn.toFixed(2)} (Lucro: R$ ${profit.toFixed(2)})`;
                } else {
                    profit = -betAmount;
                    result = `‚ùå PERDEU! Preju√≠zo: R$ ${Math.abs(profit).toFixed(2)}`;
                }
            }

            resultText.innerHTML = `
                <p><strong>Placar:</strong> ${finalScore}</p>
                <p><strong>Handicap Apostado:</strong> ${handicapLine > 0 ? '+' : ''}${handicapLine}</p>
                <p><strong>Resultado:</strong> ${result}</p>
            `;
            resultBox.classList.add('show');
            resultBox.style.borderLeftColor = profit > 0 ? '#4caf50' : profit === 0 ? '#FFB300' : '#EF4444';
        }

        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        function poissonProbability(lambda, k) {
            return (Math.pow(Math.E, -lambda) * Math.pow(lambda, k)) / factorial(k);
        }

        function calculatePoisson() {
            const teamAGoals = parseFloat(document.getElementById('team-a-goals').value);
            const teamBGoals = parseFloat(document.getElementById('team-b-goals').value);
            const resultBox = document.getElementById('result-poisson');
            const resultText = document.getElementById('result-poisson-text');
            resultBox.classList.remove('show');

            if (!teamAGoals || !teamBGoals || teamAGoals < 0 || teamBGoals < 0) {
                resultText.textContent = 'Por favor, insira m√©dias v√°lidas de gols';
                resultBox.classList.add('show');
                return;
            }

            // Calcular probabilidades para placares mais comuns
            let results = [];
            let homeWin = 0, draw = 0, awayWin = 0;

            for (let homeGoals = 0; homeGoals <= 4; homeGoals++) {
                for (let awayGoals = 0; awayGoals <= 4; awayGoals++) {
                    const probHome = poissonProbability(teamAGoals, homeGoals);
                    const probAway = poissonProbability(teamBGoals, awayGoals);
                    const probScore = probHome * probAway;

                    results.push({
                        score: `${homeGoals}x${awayGoals}`,
                        probability: probScore * 100
                    });

                    if (homeGoals > awayGoals) homeWin += probScore * 100;
                    else if (homeGoals === awayGoals) draw += probScore * 100;
                    else awayWin += probScore * 100;
                }
            }

            // Ordenar por probabilidade
            results.sort((a, b) => b.probability - a.probability);

            const topScores = results.slice(0, 6);
            let scoresText = topScores.map(r =>
                `${r.score}: ${r.probability.toFixed(1)}%`
            ).join('<br>');

            resultText.innerHTML = `
                <p><strong>Probabilidades de Resultado:</strong></p>
                <p>Vit√≥ria Casa: ${homeWin.toFixed(1)}%</p>
                <p>Empate: ${draw.toFixed(1)}%</p>
                <p>Vit√≥ria Visitante: ${awayWin.toFixed(1)}%</p><br>
                <p><strong>Placares Mais Prov√°veis:</strong></p>
                <p>${scoresText}</p>
            `;
            resultBox.classList.add('show');
            resultBox.style.borderLeftColor = '#4caf50';
        }

        // --- FIM FUN√á√ïES CALCULADORAS AVAN√áADAS ---
        
        // --- CHATBOT GEMINI INTEGRATION ---

        // Global constants for API access
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const API_KEY = ""; // Canvas provides this dynamically if empty string

        function appendChatbotMessage(msg, from='bot') {
            const d = document.createElement('div');
            d.style.margin = '7px 0';
            d.style.textAlign = from === 'user' ? 'right' : 'left';
            // Usa as cores do Tailwind definidas
            const bgColor = from === 'user' ? '#DCF8C6' : '#eee';
            d.innerHTML = `<span style="background:${bgColor};padding:7px 11px;border-radius:14px;display:inline-block;max-width:88%;font-size:15px;line-height:1.4">${msg}</span>`;
            const messagesContainer = document.getElementById('ai-chat-messages');
            messagesContainer.appendChild(d);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function callGeminiAPI(query) {
            const fullApiUrl = API_URL + API_KEY;
            const systemPrompt = "Voc√™ √© um assistente de apostas esportivas amig√°vel e experiente. Responda √†s perguntas sobre estrat√©gias de apostas, an√°lise de times e conceitos matem√°ticos (como EV, Kelly). Seja claro, conciso e sempre promova a gest√£o de banca respons√°vel (Stake de 1% a 5%). Voc√™ n√£o tem acesso a odds em tempo real, mas pode usar a busca do Google para obter informa√ß√µes atuais sobre times e ligas.";
            
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                tools: [{"google_search": {}}] // Enable search for general info
            };

            const MAX_RETRIES = 3;
            let delay = 1000;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(fullApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Se for um erro de limite de taxa ou erro transit√≥rio, tenta novamente
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Transient API error: ${response.status}`);
                        }
                        // Para erros de cliente (4xx diferente de 429), sai e relata imediatamente
                        throw new Error(`Falha ao buscar conte√∫do: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Desculpe, a IA n√£o conseguiu gerar uma resposta no momento.";
                    return text;

                } catch (error) {
                    console.error(`Tentativa ${i + 1} falhou: ${error.message}`);
                    if (i === MAX_RETRIES - 1 || !error.message.includes("Transient API error")) {
                        return "‚ùå Erro: O servi√ßo de IA falhou ap√≥s v√°rias tentativas. Tente novamente mais tarde.";
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Backoff exponencial
                }
            }
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('ai-chat-input');
            const form = document.getElementById('ai-chat-form');
            const query = input.value.trim();
            if (!query) return;

            appendChatbotMessage(query, 'user');
            input.value = '';
            
            // Desabilita o formul√°rio durante a consulta
            input.disabled = true;
            form.querySelector('button').disabled = true;

            const loadingMsg = "Pensando... (Consultando a IA)";
            appendChatbotMessage(loadingMsg);
            
            const responseText = await callGeminiAPI(query);
            
            // Encontra e substitui a mensagem de carregamento tempor√°ria pela resposta final
            const messagesContainer = document.getElementById('ai-chat-messages');
            if (messagesContainer.lastChild) {
                 const lastSpan = messagesContainer.lastChild.querySelector('span');
                 if (lastSpan && lastSpan.innerHTML === loadingMsg) {
                    messagesContainer.removeChild(messagesContainer.lastChild);
                }
            }
            
            appendChatbotMessage(responseText);
            
            // Reabilita o formul√°rio
            input.disabled = false;
            form.querySelector('button').disabled = false;
            input.focus();
        }

        function toggleChatbot() {
            const container = document.getElementById('ai-chatbot-container');
            const button = document.getElementById('chatbot-toggle-button');

            if (container.classList.contains('open')) {
                container.classList.remove('open');
                button.textContent = 'üí¨';
            } else {
                container.classList.add('open');
                button.textContent = '‚ùå';
                // Garante que o input do chat esteja focado e a mensagem de boas-vindas vis√≠vel
                setTimeout(() => {
                    document.getElementById('ai-chat-input').focus();
                }, 300);
            }
        }

        function initChatbot() {
            const form = document.getElementById('ai-chat-form');
            if (form) {
                form.addEventListener('submit', handleChatSubmit);
            }
            // Mensagem de boas-vindas inicial (sempre a primeira mensagem, mesmo que oculto)
            appendChatbotMessage("Ol√°! Sou o Assistente de Estrat√©gias de Apostas. Pergunte sobre conceitos (EV, Kelly, Stake), an√°lise de times (usando o Google Search) ou sobre os jogos simulados na p√°gina!");
        }

        // --- FIM CHATBOT GEMINI INTEGRATION ---

        
        /**
         * Inicializa√ß√£o: Carrega a banca do localStorage e carrega a an√°lise, e inicia o auto-update.
         */
        function init() {
            // 1. Carrega a banca
            const storedBankroll = localStorage.getItem('userBankroll');
            const bankrollInput = document.getElementById('bankroll-input');
            
            if (storedBankroll) {
                bankrollInput.value = storedBankroll;
                // Chama saveBankroll para inicializar a vari√°vel global e o status E carregar a an√°lise inicial.
                saveBankroll(); 
            } else {
                // Se n√£o h√° banca salva, apenas carrega a an√°lise inicial
                loadAnalysis();
            }

            // 2. Garante que o input atualize o localStorage
            bankrollInput.addEventListener('input', () => {
                const value = parseFloat(bankrollInput.value);
                if (!isNaN(value) && value > 0) {
                    localStorage.setItem('userBankroll', value);
                } else {
                    localStorage.removeItem('userBankroll');
                }
            });
            
            // 3. Corrige o estilo do resultado das calculadoras avan√ßadas
            document.querySelectorAll('.result-box-advanced').forEach(box => {
                box.classList.add('bg-white');
                box.style.padding = '12px';
                box.style.borderLeftWidth = '4px';
                box.style.borderLeftColor = '#4caf50'; // Default green
            });

            // 4. Inicializa o novo chatbot Gemini
            initChatbot();

            // 5. --- NOVO: Configura a atualiza√ß√£o autom√°tica ---
            setInterval(() => {
                console.log("Atualizando jogos automaticamente...");
                loadAnalysis(false); // N√£o mostra o loading para atualiza√ß√µes em background
            }, AUTO_UPDATE_INTERVAL);

        }


        // Inicializar a aplica√ß√£o ao carregar a p√°gina
        window.onload = init;
    </script>
</body>
</html>